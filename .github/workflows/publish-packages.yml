name: Publish NuGet Packages

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '10.0.x'
  CONFIGURATION: 'Release'

jobs:
  publish-nuget-org:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write  # enable GitHub OIDC token issuance for trusted publishing

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: get-version
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore -p:Version=${{ steps.get-version.outputs.VERSION }}

    - name: Pack packages
      run: dotnet pack --configuration ${{ env.CONFIGURATION }} --no-build --output ./packages -p:PackageVersion=${{ steps.get-version.outputs.VERSION }}

    - name: NuGet login (OIDC â†’ temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: meirb  # Your nuget.org username

    - name: Publish packages to NuGet.org
      run: |
        for package in ./packages/*.nupkg; do
          echo "Publishing $package to NuGet.org..."
          dotnet nuget push "$package" --source https://api.nuget.org/v3/index.json --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} --skip-duplicate
        done
